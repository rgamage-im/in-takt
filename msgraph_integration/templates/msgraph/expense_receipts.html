{% extends 'base.html' %}
{% load static %}

{% block title %}Expense Receipts - In-Takt{% endblock %}

{% block extra_css %}
<!-- Tabulator CSS -->
<link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
<style>
    /* Tabulator theme customization */
    .tabulator {
        font-size: 14px;
        border: 1px solid #dee2e6;
    }

    .tabulator-header {
        background-color: var(--color-deep-navy) !important;
        color: white !important;
        border: none;
    }

    .tabulator-header .tabulator-col {
        background-color: var(--color-deep-navy) !important;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tabulator-header .tabulator-col-title {
        color: white !important;
    }

    /* Header filter input styling */
    .tabulator-header-filter input {
        color: #1A2A3A !important;
        background-color: white !important;
        border: 1px solid #cbd5e0 !important;
        padding: 4px 8px !important;
    }

    .tabulator-header-filter input::placeholder {
        color: #a0aec0 !important;
    }

    .tabulator-row:hover {
        background-color: rgba(123, 182, 224, 0.1) !important;
    }

    .tabulator-row.tabulator-selected {
        background-color: rgba(193, 78, 50, 0.1) !important;
    }

    .tabulator .tabulator-footer {
        background-color: var(--color-light-sand);
        border-top: 2px solid var(--color-deep-navy);
    }

    /* Loading overlay */
    #loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .spinner {
        border: 4px solid var(--color-light-sand);
        border-top: 4px solid var(--color-warm-brick);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold" style="color: var(--color-deep-navy);">
                    Expense Receipts
                </h1>
                <p class="mt-2 text-sm" style="color: var(--color-olive-gray);">
                    View and search expense receipt files from SharePoint
                </p>
            </div>
            <div class="flex gap-3">
                <a href="/graph/profile/" class="px-4 py-2 rounded-md text-white font-medium hover:opacity-90 transition-opacity" style="background-color: var(--color-warm-brick);">
                    ← Back to Profile
                </a>
                <a href="/graph/api/receipts/expense/" class="px-4 py-2 rounded-md text-white font-medium hover:opacity-90 transition-opacity" style="background-color: var(--color-olive-gray);">
                    View Raw API
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4 border-l-4" style="border-left-color: var(--color-warm-brick);">
            <div class="text-sm font-medium" style="color: var(--color-olive-gray);">Total Files</div>
            <div id="stat-total" class="text-2xl font-bold mt-1" style="color: var(--color-deep-navy);">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 border-l-4" style="border-left-color: #48BB78;">
            <div class="text-sm font-medium" style="color: var(--color-olive-gray);">Total Amount</div>
            <div id="stat-amount" class="text-2xl font-bold mt-1" style="color: var(--color-deep-navy);">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 border-l-4" style="border-left-color: var(--color-soft-sky-blue);">
            <div class="text-sm font-medium" style="color: var(--color-olive-gray);">Total Size</div>
            <div id="stat-size" class="text-2xl font-bold mt-1" style="color: var(--color-deep-navy);">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 border-l-4" style="border-left-color: var(--color-olive-gray);">
            <div class="text-sm font-medium" style="color: var(--color-olive-gray);">Location</div>
            <div id="stat-location" class="text-lg font-semibold mt-1" style="color: var(--color-deep-navy);">-</div>
        </div>
    </div>

    <!-- Table Container -->
    <div class="bg-white rounded-lg shadow-lg p-6" style="position: relative; min-height: 500px;">
        <div id="loading-overlay">
            <div class="spinner"></div>
        </div>

        <div class="mb-4">
            <h2 class="text-lg font-semibold mb-2" style="color: var(--color-deep-navy);">Receipt Files</h2>
            <p class="text-sm" style="color: var(--color-olive-gray);">
                Click column headers to sort • Use search filters to find specific files • Click filename to open in browser
            </p>
        </div>

        <div id="receipts-table"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Tabulator JS -->
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>

<script>
// Initialize Tabulator when page loads
document.addEventListener('DOMContentLoaded', function() {

    // Get CSRF token for POST requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Date/time formatter
    var dateTimeFormatter = function(cell, formatterParams, onRendered){
        var value = cell.getValue();
        if (!value) return "-";
        var date = new Date(value);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    };

    // File size formatter
    var fileSizeFormatter = function(cell, formatterParams, onRendered){
        var bytes = cell.getValue();
        if (!bytes || bytes === 0) return "-";

        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
    };

    // Currency formatter
    var currencyFormatter = function(cell, formatterParams, onRendered){
        var amount = cell.getValue();
        if (amount === null || amount === undefined) return "-";

        return '$' + parseFloat(amount).toFixed(2);
    };

    // QuickBooks match status formatter
    var qbMatchFormatter = function(cell, formatterParams, onRendered){
        var rowData = cell.getRow().getData();
        var matchStatus = rowData.qb_match_status;
        var matchCount = rowData.qb_match_count || 0;

        if (matchStatus === 'single') {
            // Upload button for single match
            return '<button class="upload-btn px-3 py-1 rounded text-white text-sm font-medium hover:opacity-90" ' +
                   'style="background-color: var(--color-warm-brick);" ' +
                   'data-file-id="' + rowData.id + '" ' +
                   'data-drive-id="' + rowData.driveId + '" ' +
                   'data-transaction-id="' + rowData.qb_transaction_id + '" ' +
                   'data-file-name="' + rowData.name + '" ' +
                   'data-mime-type="' + rowData.mimeType + '">' +
                   'Upload</button>';
        } else if (matchStatus === 'multiple') {
            // Yellow warning for multiple matches
            var tooltip = matchCount + ' matching transactions found';
            return '<svg class="w-6 h-6 mx-auto" style="color: #F59E0B;" fill="currentColor" viewBox="0 0 20 20" title="' + tooltip + '">' +
                   '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>' +
                   '</svg>';
        }

        // No match or no amount - return empty
        return '';
    };

    // Filename with link formatter
    var filenameLinkFormatter = function(cell, formatterParams, onRendered){
        var rowData = cell.getRow().getData();
        var filename = rowData.name;
        var webUrl = rowData.webUrl;

        if (!filename) return "-";

        if (webUrl) {
            return '<a href="' + webUrl + '" target="_blank" style="color: var(--color-warm-brick); text-decoration: underline; font-weight: 500;">' +
                   filename + '</a>';
        }
        return filename;
    };

    // Initialize the table
    var table = new Tabulator("#receipts-table", {
        ajaxURL: "/graph/api/receipts/expense/?_t=" + Date.now(),
        ajaxConfig: {
            credentials: "same-origin",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "Cache-Control": "no-cache, no-store, must-revalidate",
                "Pragma": "no-cache"
            }
        },
        ajaxResponse: function(url, params, response){
            // Hide loading overlay when data arrives
            document.getElementById('loading-overlay').style.display = 'none';

            // Update stats
            updateStats(response);

            // Return the files array
            return response.value || [];
        },
        layout: "fitDataFill",
        pagination: true,
        paginationSize: 25,
        paginationSizeSelector: [10, 25, 50, 100],
        movableColumns: true,
        resizableColumns: true,
        initialSort: [
            {column: "createdDateTime", dir: "desc"}
        ],
        columns: [
            {
                title: "File Name",
                field: "name",
                sorter: "string",
                formatter: filenameLinkFormatter,
                minWidth: 250,
                headerFilter: "input"
            },
            {
                title: "Amount",
                field: "amount",
                sorter: "number",
                formatter: currencyFormatter,
                width: 120,
                hozAlign: "right",
                headerFilter: "input"
            },
            {
                title: "QB Match",
                field: "qb_match_status",
                sorter: "string",
                formatter: qbMatchFormatter,
                width: 100,
                hozAlign: "center",
                tooltip: function(e, cell, onRendered){
                    var rowData = cell.getRow().getData();
                    if (rowData.qb_match_status === 'single') {
                        return "QuickBooks transaction found";
                    } else if (rowData.qb_match_status === 'multiple') {
                        return rowData.qb_match_count + " matching QuickBooks transactions found";
                    }
                    return "";
                }
            },
            {
                title: "Size",
                field: "size",
                sorter: "number",
                formatter: fileSizeFormatter,
                width: 120,
                hozAlign: "right"
            },
            {
                title: "Created Date",
                field: "createdDateTime",
                sorter: function(a, b, aRow, bRow, column, dir, sorterParams){
                    var aDate = a ? new Date(a).getTime() : 0;
                    var bDate = b ? new Date(b).getTime() : 0;
                    return aDate - bDate;
                },
                formatter: dateTimeFormatter,
                width: 180,
                headerFilter: "input"
            },
            {
                title: "Created By",
                field: "createdBy",
                sorter: "string",
                width: 180,
                headerFilter: "input"
            },
            {
                title: "File Type",
                field: "mimeType",
                sorter: "string",
                width: 150,
                headerFilter: "input",
                formatter: function(cell, formatterParams, onRendered){
                    var value = cell.getValue();
                    if (!value) return "-";

                    // Simplify MIME type for display
                    if (value.includes('pdf')) return 'PDF';
                    if (value.includes('image')) return 'Image';
                    if (value.includes('word')) return 'Word';
                    if (value.includes('excel') || value.includes('spreadsheet')) return 'Excel';
                    if (value.includes('text')) return 'Text';

                    return value.split('/')[1] || value;
                }
            }
        ],
        rowClick: function(e, row){
            // Handle row click - open file in new tab
            var data = row.getData();
            if (data.webUrl) {
                window.open(data.webUrl, '_blank');
            }
        }
    });

    // Update statistics
    function updateStats(response) {
        if (!response || !response.value) return;

        // Total files
        var totalFiles = response.totalFiles || response.value.length || 0;
        document.getElementById('stat-total').textContent = totalFiles;

        // Total amount
        var totalAmount = 0;
        var parsedCount = 0;
        response.value.forEach(function(file) {
            if (file.amount !== null && file.amount !== undefined) {
                totalAmount += file.amount;
                parsedCount++;
            }
        });

        // Format total amount
        if (parsedCount > 0) {
            document.getElementById('stat-amount').textContent = '$' + totalAmount.toFixed(2);
        } else {
            document.getElementById('stat-amount').textContent = '-';
        }

        // Total size
        var totalSize = 0;
        response.value.forEach(function(file) {
            totalSize += file.size || 0;
        });

        // Format total size
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(totalSize) / Math.log(1024));
        var formattedSize = (totalSize / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
        document.getElementById('stat-size').textContent = formattedSize;

        // Location
        var location = "Expense Receipts";
        if (response.folderInfo && response.folderInfo.location) {
            location = response.folderInfo.location;
        }
        document.getElementById('stat-location').textContent = location;
    }

    // Handle upload button clicks
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('upload-btn')) {
            e.stopPropagation(); // Prevent row click event

            const button = e.target;
            const fileId = button.dataset.fileId;
            const driveId = button.dataset.driveId;
            const transactionId = button.dataset.transactionId;
            const fileName = button.dataset.fileName;
            const mimeType = button.dataset.mimeType;

            // Disable button and show loading state
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Uploading...';
            button.style.opacity = '0.6';

            // Call the upload API
            fetch('/graph/api/receipts/upload-to-quickbooks/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    file_id: fileId,
                    drive_id: driveId,
                    transaction_id: transactionId,
                    file_name: fileName,
                    mime_type: mimeType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success state
                    button.textContent = '✓ Uploaded';
                    button.style.backgroundColor = '#48BB78'; // Green
                    button.style.opacity = '1';

                    // Show success message
                    alert('Success! Receipt uploaded and attached to QuickBooks transaction.');
                } else {
                    // Log full error data to console
                    console.error('Upload failed - Full error data:', data);

                    if (data.debug_response) {
                        console.log('QuickBooks API Response:', data.debug_response);
                    }

                    let errorMsg = data.error || 'Upload failed';
                    throw new Error(errorMsg);
                }
            })
            .catch(error => {
                // Restore button and show error
                button.disabled = false;
                button.textContent = originalText;
                button.style.opacity = '1';

                alert('Error uploading receipt: ' + error.message);
                console.error('Upload error:', error);
            });
        }
    });
});
</script>
{% endblock %}
